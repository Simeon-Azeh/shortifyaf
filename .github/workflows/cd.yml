name: CD - Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  ACR_REPOSITORY: ${{ secrets.ACR_REPOSITORY }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Run CI checks
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install backend dependencies
      run: |
        cd backend
        npm ci

    - name: Run lint
      run: |
        cd backend
        npm run lint

    - name: Run tests
      run: |
        cd backend
        npm test

    # Scan Terraform
    - name: Install tfsec
      run: |
        curl -sSL https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

    - name: Run tfsec
      run: |
        if [ -d terraform ]; then
          tfsec terraform
        else
          echo "No terraform directory found"
        fi

    # Azure login and ACR login
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to ACR
      run: |
        echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ secrets.ACR_LOGIN_SERVER }} \
          --username "${{ secrets.ACR_USERNAME }}" --password-stdin

    # Build and push image
    - name: Build and push Docker image
      id: build
      run: |
        TAG=${GITHUB_SHA::8}
        IMAGE_URI=${{ secrets.ACR_LOGIN_SERVER }}/${{ secrets.ACR_REPOSITORY }}:$TAG
        docker build -t "$IMAGE_URI" .
        docker push "$IMAGE_URI"
        echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT

    # Scan image with Trivy
    - name: Run Trivy scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ steps.build.outputs.image_uri }}
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'

    # Deploy with Ansible
    - name: Install Ansible
      run: |
        sudo apt-get update -y
        sudo apt-get install -y python3 python3-pip openssh-client
        pip3 install --user ansible paramiko

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H "${{ secrets.SSH_BASTION_HOST }}" >> ~/.ssh/known_hosts

    - name: Create Ansible inventory
      run: |
        mkdir -p ansible/inventory
        cat > ansible/inventory/hosts.ini <<EOF
        [bastion]
        bastion ansible_host=${{ secrets.SSH_BASTION_HOST }} ansible_user=${{ secrets.SSH_BASTION_USER }}

        [appserver]
        app ansible_host=${{ secrets.APP_HOST_PRIVATE }} ansible_user=${{ secrets.SSH_APP_USER }} ansible_ssh_common_args='-o ProxyCommand="ssh -W %h:%p -q -o StrictHostKeyChecking=no -l ${{ secrets.SSH_BASTION_USER }} ${{ secrets.SSH_BASTION_HOST }}"'
        EOF

    - name: Run Ansible playbook
      run: |
        ansible-playbook -i ansible/inventory/hosts.ini ansible/deploy.yml \
          --extra-vars "image_uri=${{ steps.build.outputs.image_uri }}"

    - name: Deployment complete
      run: |
        echo "Deployment finished successfully"
        echo "Image: ${{ steps.build.outputs.image_uri }}"