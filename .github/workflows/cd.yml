name: CD - Deploy to Production (Azure)

on:
  push:
    branches: [ main ]

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  ACR_REPOSITORY: ${{ secrets.ACR_REPOSITORY }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    # -----------------------------
    # 0) Checkout
    # -----------------------------
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # -----------------------------
    # 1) Run CI (lint + tests)
    # -----------------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        cd backend || exit 0
        npm ci

    - name: Run lint
      run: |
        cd backend
        if npm run | grep -q lint; then npm run lint; else echo "No lint script"; fi

    - name: Run tests
      run: |
        cd backend
        if npm run | grep -q test; then npm test; else echo "No test script"; fi

    # -----------------------------
    # 2) Terraform scan (tfsec)
    # -----------------------------
    - name: Install tfsec
      run: |
        curl -sSL https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

    - name: Run tfsec
      run: |
        if [ -d terraform ]; then tfsec terraform || true; else echo "No terraform directory"; fi

    # -----------------------------
    # 3) Authenticate to Azure & Login to ACR
    # -----------------------------
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Azure Container Registry Login
      run: |
        echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ secrets.ACR_LOGIN_SERVER }} \
          --username "${{ secrets.ACR_USERNAME }}" --password-stdin

    # -----------------------------
    # 4) Build & Push Docker image to ACR
    # -----------------------------
    - name: Build and push backend image
      id: build
      run: |
        TAG=${GITHUB_SHA::8}
        IMAGE_URI=${{ secrets.ACR_LOGIN_SERVER }}/${{ secrets.ACR_REPOSITORY }}-backend:$TAG
        docker build -f backend/Dockerfile -t "$IMAGE_URI" backend
        docker push "$IMAGE_URI"
        echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT

    # -----------------------------
    # 5) Container image scanning (Trivy)
    # -----------------------------
    - name: Trivy scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ steps.build.outputs.image_uri }}
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'

    # -----------------------------
    # 6) Ansible deploy (through bastion)
    # -----------------------------
    - name: Install Ansible
      run: |
        sudo apt-get update -y
        sudo apt-get install -y python3 python3-pip openssh-client
        pip3 install --user ansible paramiko

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H "${{ secrets.SSH_BASTION_HOST }}" >> ~/.ssh/known_hosts
        ssh-keyscan -H "${{ secrets.APP_HOST_PRIVATE }}" >> ~/.ssh/known_hosts

    - name: Prepare inventory
      run: |
        mkdir -p ansible/inventory
        cat > ansible/inventory/hosts.ini <<EOF
[bastion]
bastion ansible_host=${{ secrets.SSH_BASTION_HOST }} ansible_user=${{ secrets.SSH_BASTION_USER }}

[appserver]
app ansible_host=${{ secrets.APP_HOST_PRIVATE }} ansible_user=${{ secrets.SSH_APP_USER }} ansible_ssh_common_args='-o ProxyCommand="ssh -W %h:%p -q -l ${{ secrets.SSH_BASTION_USER }} ${{ secrets.SSH_BASTION_HOST }}"'
EOF

    - name: Deploy with Ansible
      run: |
        ansible-playbook -i ansible/inventory/hosts.ini ansible/deploy.yml \
        --extra-vars "image_uri=${{ steps.build.outputs.image_uri }}"
