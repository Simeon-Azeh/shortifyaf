---
- name: Deploy ShortifyAF on Azure VM
  hosts: appserver
  become: yes
  vars:
    app_dir: "{{ lookup('env','ANSIBLE_PULL_PATH') | default('/home/azureuser/shortifyaf') }}"
    docker_compose_file: "{{ app_dir }}/docker-compose.yml"
    image_uri: "{{ image_uri }}"

  tasks:
    - name: Ensure app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Pull or update repo on target (git clone if missing)
      become: yes
      block:
        - name: Check if repo exists
          stat:
            path: "{{ app_dir }}/.git"
          register: repo_exists

        - name: Clone repo if missing
          command: git clone https://github.com/Simeon-Azeh/shortifyaf.git "{{ app_dir }}"
          when: not repo_exists.stat.exists

        - name: Pull latest if repo exists
          command: git -C "{{ app_dir }}" pull
          when: repo_exists.stat.exists

    - name: Write production docker-compose.yml on the server
      copy:
        dest: "{{ docker_compose_file }}"
        content: |
          version: "3.8"
          services:
            mongodb:
              image: mongo:7-jammy
              restart: unless-stopped
              environment:
                MONGO_INITDB_DATABASE: shortifyaf
              volumes:
                - mongodb_data:/data/db
              networks:
                - shortifyaf-network

            backend:
              image: {{ image_uri }}
              restart: unless-stopped
              environment:
                PORT: 3001
                MONGODB_URI: mongodb://mongodb:27017/shortifyaf
                FRONTEND_URL: http://localhost
              depends_on:
                - mongodb
              networks:
                - shortifyaf-network

            frontend:
              build:
                context: ./frontend
                dockerfile: Dockerfile
              restart: unless-stopped
              environment:
                VITE_API_URL: http://localhost:3001
              depends_on:
                - backend
              networks:
                - shortifyaf-network
              ports:
                - "80:80"

          volumes:
            mongodb_data:

          networks:
            shortifyaf-network:
              driver: bridge
      notify: Restart compose

  handlers:
    - name: Restart compose
      become: yes
      shell: |
        cd {{ app_dir }} || exit 1
        # make sure docker compose plugin available
        docker compose pull backend || true
        docker compose build frontend || true
        docker compose up -d --remove-orphans
      args:
        warn: false
