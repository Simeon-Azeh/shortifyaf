---
- name: Ensure Docker and Dependencies are Installed
  hosts: app_servers
  become: yes
  gather_facts: false

  pre_tasks:
    - name: Check if python3.8 is available
      raw: test -x /usr/bin/python3.8
      register: python38_check
      failed_when: false
      changed_when: false

    - name: Install Python 3.8 if missing (Debian/Ubuntu)
      raw: |
        set -e
        apt-get update -y
        apt-get install -y software-properties-common
        add-apt-repository -y ppa:deadsnakes/ppa || true
        apt-get update -y
        apt-get install -y python3.8 python3.8-venv python3.8-distutils python3.8-dev python3-pip || apt-get install -y python3 python3-pip
      when: python38_check.rc != 0

    - name: Re-check if python3.8 is available
      raw: test -x /usr/bin/python3.8
      register: python38_check_after
      failed_when: false
      changed_when: false

    - name: Set ansible_python_interpreter to python3.8 if present
      set_fact:
        ansible_python_interpreter: "/usr/bin/python3.8"
      when: python38_check_after.rc == 0

    - name: Set ansible_python_interpreter to python3 if python3.8 not present
      set_fact:
        ansible_python_interpreter: "/usr/bin/python3"
      when: python38_check_after.rc != 0

    - name: Gather facts after ensuring Python is installed
      setup:

  tasks:
    - name: Check if Docker is installed
      command: which docker
      register: docker_installed
      failed_when: false
      changed_when: false

    - name: Check if docker-compose is installed
      command: which docker-compose
      register: compose_installed
      failed_when: false
      changed_when: false

    - name: Check if Azure CLI is installed
      command: which az
      register: az_installed
      failed_when: false
      changed_when: false

    - name: Install Docker and dependencies if missing
      block:
        - name: Update apt cache
          apt:
            update_cache: yes

        - name: Install required packages
          apt:
            name:
              - curl
              - wget
              - git
              - python3
              - python3-pip
              - build-essential
              - ca-certificates
              - gnupg
              - lsb-release
              - apt-transport-https
              - software-properties-common
            state: present

        - name: Add Docker official GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present
            filename: docker

        - name: Install Docker Engine
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
            state: present
            update_cache: yes

        - name: Install Docker Compose
          get_url:
            url: "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64"
            dest: /usr/local/bin/docker-compose
            mode: "0755"

        - name: Create symbolic link for docker-compose
          file:
            src: /usr/local/bin/docker-compose
            dest: /usr/bin/docker-compose
            state: link

        - name: Ensure Docker service is running
          systemd:
            name: docker
            state: started
            enabled: yes
            daemon_reload: yes

        - name: Add azureuser to docker group
          user:
            name: azureuser
            groups: docker
            append: yes

        - name: Ensure azureuser can run docker and docker-compose as sudo without password
          copy:
            dest: /etc/sudoers.d/azureuser
            content: |
              azureuser ALL=(ALL) NOPASSWD: /usr/bin/docker, /usr/local/bin/docker-compose, /usr/bin/docker-compose
            mode: "0440"

        - name: Restart Docker to ensure socket is available and group membership applied
          systemd:
            name: docker
            state: restarted
        - name: Create app directory
          file:
            path: /home/azureuser/shortifyaf
            state: directory
            owner: azureuser
            group: azureuser
            mode: "0755"

        - name: Create .env with provided vars (if any)
          copy:
            dest: /home/azureuser/shortifyaf/.env
            content: |
              DATABASE_URL={{ database_url | default('') }}
              FRONTEND_URL={{ frontend_url | default('') }}
            owner: azureuser
            group: azureuser
            mode: "0600"
      when: docker_installed.rc != 0

    - name: Install docker-compose if missing
      block:
        - name: Download docker-compose v2 binary
          get_url:
            url: "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64"
            dest: /usr/local/bin/docker-compose
            mode: "0755"

        - name: Create symlink for docker-compose
          file:
            src: /usr/local/bin/docker-compose
            dest: /usr/bin/docker-compose
            state: link
      when: compose_installed.rc != 0

    - name: Install Azure CLI if missing (Debian/Ubuntu)
      block:
        - name: Add Microsoft signing key
          apt_key:
            url: https://packages.microsoft.com/keys/microsoft.asc
            state: present

        - name: Add Azure CLI apt repository
          apt_repository:
            repo: "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ {{ ansible_distribution_release }} main"
            state: present

        - name: Update apt cache
          apt:
            update_cache: yes

        - name: Install azure-cli
          apt:
            name: azure-cli
            state: present
      when: az_installed.rc != 0

    - name: Azure login using service principal (for ACR auth)
      shell: az login --service-principal -u "{{ azure_client_id }}" -p "{{ azure_client_secret }}" --tenant "{{ azure_tenant_id }}"
      args:
        warn: false
      when: azure_client_id is defined and azure_client_secret is defined and azure_tenant_id is defined

    - name: Get ACR name from login server
      set_fact:
        acr_name: "{{ acr_login_server.split('.')[0] }}"
      when: acr_login_server is defined

    - name: Login to ACR
      shell: az acr login --name "{{ acr_name }}"
      when: acr_name is defined

    - name: Ensure app directory exists (unconditional)
      file:
        path: /home/azureuser/shortifyaf
        state: directory
        owner: azureuser
        group: azureuser
        mode: "0755"

    - name: Create .env with provided vars (if any) - unconditional
      copy:
        dest: /home/azureuser/shortifyaf/.env
        content: |
          DATABASE_URL={{ database_url | default('') }}
          FRONTEND_URL={{ frontend_url | default('') }}
        owner: azureuser
        group: azureuser
        mode: "0600"
      when: database_url is defined or frontend_url is defined

    - name: Verify Docker service is running
      command: systemctl is-active docker
      register: docker_service
      failed_when: docker_service.rc != 0

    - name: Verify docker-compose is installed
      command: docker-compose --version
      register: docker_compose_ver
      failed_when: docker_compose_ver.rc != 0

    - name: Show installation results
      debug:
        msg:
          - "Docker service: {{ docker_service.stdout }}"
          - "Docker Compose: {{ docker_compose_ver.stdout }}"
