---
- name: Configure App VM with Docker and Docker Compose
  hosts: app_servers
  become: yes
  gather_facts: no

  pre_tasks:
    - name: Ensure Python 3 is available
      raw: test -e /usr/bin/python3 || (apt-get update && apt-get install -y python3)
      args:
        warn: false
      changed_when: false

    - name: Gather facts
      setup:

  tasks:
    - name: Check if Docker is already installed
      command: which docker
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Update package cache
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        timeout 300 apt-get update -y
      args:
        warn: false
      when: docker_check.rc != 0
      ignore_errors: true

    - name: Install required system packages
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release software-properties-common git wget
      args:
        warn: false
      when: docker_check.rc != 0

    - name: Add Docker's official GPG key
      raw: |
        mkdir -p /usr/share/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
      args:
        warn: false
      when: docker_check.rc != 0

    - name: Set up Docker stable repository
      raw: |
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
      args:
        warn: false
      when: docker_check.rc != 0

    - name: Install Docker Engine
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -y
        apt-get install -y docker-ce docker-ce-cli containerd.io
      args:
        warn: false
      when: docker_check.rc != 0

    - name: Install Docker Compose
      raw: |
        curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        chmod +x /usr/local/bin/docker-compose
        ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
      args:
        warn: false
      when: docker_check.rc != 0

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add user to docker group
      user:
        name: azureuser
        groups: docker
        append: yes

    - name: Verify Docker installation
      command: docker --version
      register: docker_version
      changed_when: false

    - name: Verify Docker Compose installation
      command: docker-compose --version
      register: docker_compose_version
      changed_when: false

    - name: Install Azure CLI prerequisites
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get install -y ca-certificates curl apt-transport-https lsb-release gnupg
      args:
        warn: false

    - name: Add Microsoft apt key
      raw: |
        curl -sL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor | tee /etc/apt/trusted.gpg.d/microsoft.gpg > /dev/null
      args:
        warn: false

    - name: Add Azure CLI apt repository
      raw: |
        echo "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/azure-cli.list
      args:
        warn: false

    - name: Install Azure CLI
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -y
        apt-get install -y azure-cli
      args:
        warn: false

    - name: Create application directory
      file:
        path: /home/azureuser/shortifyaf
        state: directory
        owner: azureuser
        group: azureuser
        mode: "0755"

    - name: Copy docker-compose.yml
      copy:
        src: "{{ playbook_dir }}/../docker-compose.yml"
        dest: /home/azureuser/shortifyaf/docker-compose.yml
        owner: azureuser
        group: azureuser
        mode: "0644"

    - name: Create environment file
      copy:
        dest: /home/azureuser/shortifyaf/.env
        content: |
          ACR_LOGIN_SERVER={{ acr_login_server }}
          DATABASE_URL={{ database_url }}
          AZURE_CLIENT_ID={{ azure_client_id }}
          AZURE_CLIENT_SECRET={{ azure_client_secret }}
          AZURE_TENANT_ID={{ azure_tenant_id }}
          FRONTEND_URL={{ frontend_url }}
        owner: azureuser
        group: azureuser
        mode: "0600"

    - name: Create Azure config directory
      file:
        path: /tmp/azure-config
        state: directory
        mode: "0700"

    - name: Login to Azure Container Registry
      shell: az acr login --name "{{ acr_login_server.split('.')[0] }}" --username "{{ azure_client_id }}" --password "{{ azure_client_secret }}" --output none
      environment:
        AZURE_CONFIG_DIR: /tmp/azure-config
      when: azure_client_id is defined and azure_client_secret is defined and azure_tenant_id is defined and acr_login_server is defined

    - name: Pull Docker images
      shell: |
        cd /home/azureuser/shortifyaf
        docker-compose pull
      environment:
        DOCKER_CLIENT_TIMEOUT: "120"
        COMPOSE_HTTP_TIMEOUT: "120"

    - name: Start application with Docker Compose
      shell: |
        cd /home/azureuser/shortifyaf
        docker-compose up -d
      environment:
        DOCKER_CLIENT_TIMEOUT: "120"
        COMPOSE_HTTP_TIMEOUT: "120"

    - name: Wait for services to start
      shell: |
        cd /home/azureuser/shortifyaf
        docker-compose ps --services --filter "status=running"
      register: running_services
      until: running_services.stdout_lines | length >= 2
      retries: 12
      delay: 10

    - name: Wait for backend port
      wait_for:
        port: 3001
        host: "127.0.0.1"
        delay: 5
        timeout: 60
        state: started

    - name: Wait for frontend port
      wait_for:
        port: 80
        host: "127.0.0.1"
        delay: 5
        timeout: 60
        state: started

    - name: Check backend health
      uri:
        url: "http://localhost:3001/health"
        method: GET
        status_code: 200
      register: health_result
      until: health_result.status == 200
      retries: 10
      delay: 5

    - name: Show running containers
      command: docker ps
      register: container_status

    - name: Display container status
      debug:
        var: container_status.stdout

    - name: Display application information
      debug:
        msg: |
          Application deployed successfully!
          Frontend: http://{{ ansible_host }}
          Backend API: http://{{ ansible_host }}:3001
          Health Check: http://{{ ansible_host }}:3001/health
