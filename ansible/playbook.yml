---
- name: Ensure Docker and Dependencies are Installed
  hosts: app_servers
  become: yes
  gather_facts: false

  pre_tasks:
    - name: Check if python3.8 is available
      raw: test -x /usr/bin/python3.8
      register: python38_check
      failed_when: false
      changed_when: false

    - name: Install Python 3.8 if missing (Debian/Ubuntu)
      raw: |
        set -e
        apt-get update -y
        apt-get install -y software-properties-common -y
        add-apt-repository -y ppa:deadsnakes/ppa || true
        apt-get update -y
        apt-get install -y python3.8 python3.8-venv python3.8-distutils python3.8-dev python3-pip -y || apt-get install -y python3 python3-pip -y
      when: python38_check.rc != 0

    - name: Re-check if python3.8 is available
      raw: test -x /usr/bin/python3.8
      register: python38_check_after
      failed_when: false
      changed_when: false

    - name: Set ansible_python_interpreter to python3.8 if present
      set_fact:
        ansible_python_interpreter: "/usr/bin/python3.8"
      when: python38_check_after.rc == 0

    - name: Set ansible_python_interpreter to python3 if python3.8 not present
      set_fact:
        ansible_python_interpreter: "/usr/bin/python3"
      when: python38_check_after.rc != 0
    - name: Gather facts after ensuring Python is installed
      ansible.builtin.setup:

  tasks:
    - name: Check if Docker is installed
      command: which docker
      register: docker_installed
      failed_when: false
      changed_when: false

    - name: Install Docker and dependencies if missing
      block:
        - name: Update apt cache
          apt: update_cache=yes

        - name: Install required packages
          apt:
            name:
              - curl
              - wget
              - git
              - python3.8
              - python3-pip
              - build-essential
              - ca-certificates
              - gnupg
              - lsb-release
              - apt-transport-https
              - software-properties-common
            state: present

        - name: Set python3.8 as default python3
          alternatives:
            name: python3
            path: /usr/bin/python3.8
            priority: 1

        - name: Add Docker official GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present
            filename: docker

        - name: Install Docker Engine
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
            state: present

        - name: Install Docker Compose
          get_url:
            url: "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64"
            dest: /usr/local/bin/docker-compose
            mode: "0755"

        - name: Create symbolic link for docker-compose
          file:
            src: /usr/local/bin/docker-compose
            dest: /usr/bin/docker-compose
            state: link

        - name: Ensure Docker service is running
          systemd:
            name: docker
            state: started
            enabled: yes

        - name: Add azureuser to docker group
          user:
            name: azureuser
            groups: docker
            append: yes

        - name: Create app directory
          file:
            path: /home/azureuser/shortifyaf
            state: directory
            owner: azureuser
            group: azureuser
            mode: "0755"

        - name: Create .env with provided vars (if any)
          copy:
            dest: /home/azureuser/shortifyaf/.env
            content: |
              DATABASE_URL={{ database_url | default('') }}
              FRONTEND_URL={{ frontend_url | default('') }}
            owner: azureuser
            group: azureuser
            mode: "0600"
      when: docker_installed.rc != 0
