---
- name: Configure App VM with Docker and Docker Compose
  hosts: app_servers
  become: yes
  gather_facts: no

  pre_tasks:
    - name: Ensure Python 3 and Git are available
      raw: |
        test -e /usr/bin/python3 || (apt-get update && apt-get install -y python3 python3-pip)
        test -e /usr/bin/git || (apt-get update && apt-get install -y git)
      args:
        warn: false
      changed_when: false

    - name: Gather facts
      setup:

  tasks:
    - name: Check if Docker is already installed
      command: which docker
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Update package cache
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        timeout 300 apt-get update -y
      args:
        warn: false
      when: docker_check.rc != 0
      ignore_errors: true

    - name: Install required system packages
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release software-properties-common git wget
      args:
        warn: false
      when: docker_check.rc != 0

    - name: Add Docker's official GPG key
      raw: |
        mkdir -p /usr/share/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
      args:
        warn: false
      when: docker_check.rc != 0

    - name: Set up Docker stable repository
      raw: |
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
      args:
        warn: false
      when: docker_check.rc != 0

    - name: Install Docker Engine
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -y
        apt-get install -y docker-ce docker-ce-cli containerd.io
      args:
        warn: false
      when: docker_check.rc != 0

    - name: Install Docker Compose
      raw: |
        curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        chmod +x /usr/local/bin/docker-compose
        ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
      args:
        warn: false
      when: docker_check.rc != 0

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add user to docker group
      user:
        name: azureuser
        groups: docker
        append: yes

    - name: Verify Docker installation
      command: docker --version
      register: docker_version
      changed_when: false

    - name: Verify Docker Compose installation
      command: docker-compose --version
      register: docker_compose_version
      changed_when: false

    - name: Display installation versions
      debug:
        msg:
          - "Docker Version: {{ docker_version.stdout }}"
          - "Docker Compose Version: {{ docker_compose_version.stdout }}"

    - name: Remove existing application directory
      file:
        path: /home/azureuser/shortifyaf
        state: absent

    - name: Clone repository
      git:
        repo: "https://github.com/Simeon-Azeh/shortifyaf.git"
        dest: /home/azureuser/shortifyaf
        version: main
        clone: yes
        update: yes
      register: clone_result
      become: true
      become_user: azureuser

    - name: Display clone status
      debug:
        var: clone_result

    - name: Create environment file
      copy:
        dest: /home/azureuser/shortifyaf/.env
        content: |
          ACR_LOGIN_SERVER={{ acr_login_server }}
          DATABASE_URL={{ database_url }}
          AZURE_CLIENT_ID={{ azure_client_id }}
          AZURE_CLIENT_SECRET={{ azure_client_secret }}
          AZURE_TENANT_ID={{ azure_tenant_id }}
          FRONTEND_URL={{ frontend_url }}
        owner: azureuser
        group: azureuser
        mode: "0600"

    - name: Configure Docker to not use credential helpers
      raw: |
        mkdir -p /home/azureuser/.docker
        echo '{}' > /home/azureuser/.docker/config.json
        chown azureuser:azureuser /home/azureuser/.docker/config.json
        chmod 600 /home/azureuser/.docker/config.json
        apt-get remove --purge -y docker-credential-secretservice golang-docker-credential-helpers || true
      args:
        warn: false
