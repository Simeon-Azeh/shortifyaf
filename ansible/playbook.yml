- name: Configure App VM with Docker
  hosts: app_servers
  become: yes
  gather_facts: no

  pre_tasks:
    - name: Ensure system Python 3 is available
      raw: |
        set -e
        command -v python3 || (apt-get update -y && apt-get install -y python3 python3-apt)
      args:
        warn: false

    - name: Gather facts
      setup:

  tasks:
    - name: Install Docker and dependencies using raw commands
      raw: |
        apt-get update -y
        apt-get install -y docker.io docker-compose-plugin curl wget git
      args:
        warn: false

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add user to docker group
      user:
        name: azureuser
        groups: docker
        append: yes

    - name: Create app directory
      file:
        path: /home/azureuser/shortifyaf
        state: directory
        owner: azureuser
        group: azureuser
        mode: "0755"

    - name: Create .env file with all required variables
      copy:
        dest: /home/azureuser/shortifyaf/.env
        content: |
          PORT=3001
          DATABASE_URL={{ database_url | default('') }}
          FRONTEND_URL={{ frontend_url | default('http://68.221.143.187/') }}
          AZURE_CLIENT_ID={{ azure_client_id | default('') }}
          AZURE_CLIENT_SECRET={{ azure_client_secret | default('') }}
          AZURE_TENANT_ID={{ azure_tenant_id | default('') }}
          ACR_LOGIN_SERVER={{ acr_login_server | default('') }}
        owner: azureuser
        group: azureuser
        mode: "0600"

    - name: Create docker-compose.yml file
      copy:
        dest: /home/azureuser/shortifyaf/docker-compose.yml
        content: |
          version: '3.8'
          services:
            backend:
              image: ${ACR_LOGIN_SERVER}/shortifyaf-backend:latest
              ports:
                - "3001:3001"
              environment:
                - PORT=3001
                - DATABASE_URL=${DATABASE_URL}
                - FRONTEND_URL=${FRONTEND_URL}
                - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
                - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET}
                - AZURE_TENANT_ID=${AZURE_TENANT_ID}
              restart: unless-stopped

            frontend:
              image: ${ACR_LOGIN_SERVER}/shortifyaf-frontend:latest
              ports:
                - "80:5173"
              environment:
                - VITE_API_URL=http://backend:3001
              restart: unless-stopped
              depends_on:
                - backend
        owner: azureuser
        group: azureuser
        mode: "0644"

    - name: Install docker-compose standalone binary (compat for scripts using docker-compose)
      get_url:
        url: "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64"
        dest: /usr/local/bin/docker-compose
        mode: "0755"
      args:
        warn: false

    - name: Create symlink for docker-compose (hyphen) to ensure compatibility
      file:
        src: /usr/local/bin/docker-compose
        dest: /usr/bin/docker-compose
        state: link

    - name: Install Azure CLI prerequisites
      apt:
        name:
          - ca-certificates
          - curl
          - apt-transport-https
          - lsb-release
          - gnupg
        state: present
        update_cache: yes

    - name: Add Microsoft apt key
      apt_key:
        url: https://packages.microsoft.com/keys/microsoft.asc
        state: present

    - name: Add Azure CLI apt repository
      apt_repository:
        repo: "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ $(lsb_release -cs) main"
        state: present

    - name: Install Azure CLI
      apt:
        name: azure-cli
        state: present
        update_cache: yes

    - name: Login to Azure using Service Principal (for ACR auth)
      shell: |
        az login --service-principal -u "{{ azure_client_id }}" -p "{{ azure_client_secret }}" --tenant "{{ azure_tenant_id }}" --output none
      args:
        warn: false
      when: azure_client_id is defined and azure_client_secret is defined and azure_tenant_id is defined

    - name: Get ACR name from login server
      set_fact:
        acr_name: "{{ acr_login_server.split('.')[0] }}"
      when: acr_login_server is defined

    - name: Login to ACR as root using az (stores credentials for root user)
      shell: |
        set -e
        TOKEN=$(az acr login --name "{{ acr_name }}" --expose-token --output tsv --query accessToken)
        echo "$TOKEN" | docker login {{ acr_login_server }} --username 00000000-0000-0000-0000-000000000000 --password-stdin
      args:
        warn: false
      become: yes
      when: acr_name is defined

    - name: If az acr login fails, use admin credentials to docker login (fallback)
      block:
        - name: Get ACR admin username
          shell: az acr credential show -n "{{ acr_name }}" --query username -o tsv
          register: acr_admin_user
          changed_when: false
        - name: Get ACR admin password
          shell: az acr credential show -n "{{ acr_name }}" --query passwords[0].value -o tsv
          register: acr_admin_pass
          changed_when: false
        - name: Login to docker with ACR admin credentials as root
          shell: echo "{{ acr_admin_pass.stdout }}" | docker login {{ acr_login_server }} --username {{ acr_admin_user.stdout }} --password-stdin
          become: yes
      rescue:
        - name: Debug register fallback failure
          debug:
            msg: "Failed to login to ACR via admin credentials"
      when: acr_name is defined
    - name: Pull and start containers with docker compose V2
      community.docker.docker_compose_v2:
        project_src: /home/azureuser/shortifyaf
        files:
          - docker-compose.yml
        pull: yes
        state: present

    - name: Wait for backend to be healthy
      wait_for:
        port: 3001
        host: localhost
        delay: 5
        timeout: 60

    - name: Check application status
      block:
        - name: Request backend health endpoint
          uri:
            url: http://localhost:3001/health
            method: GET
            status_code: 200
          register: health_check
          until: health_check.status == 200
          retries: 10
          delay: 5
      rescue:
        - name: Show backend logs to debug startup failure
          shell: docker compose -f /home/azureuser/shortifyaf/docker-compose.yml logs backend --no-color || docker logs $(docker ps -q --filter "name=shortifyaf-backend")
          register: backend_logs
        - name: Display backend logs
          debug:
            var: backend_logs.stdout
        - name: Show container ps
          command: docker ps -a
          register: all_containers
        - name: Display container ps
          debug:
            var: all_containers.stdout
        - name: Fail the play with helpful message
          fail:
            msg: "Backend health check failed; see logs above for details"

    - name: Display application status
      debug:
        msg: "Application deployed successfully! Backend running on port 3001, Frontend on port 80"

    - name: Show running containers
      command: docker ps
      register: container_status

    - name: Display container status
      debug:
        var: container_status.stdout
