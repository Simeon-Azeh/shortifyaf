- name: Configure App VM with Docker
  hosts: app_servers
  become: yes
  gather_facts: no

  pre_tasks:
    - name: Ensure system Python 3 is available
      raw: |
        set -e
        command -v python3 || (apt-get update -y && apt-get install -y python3 python3-apt)
      args:
        warn: false

    - name: Gather facts
      setup:

  tasks:
    - name: Install Docker and dependencies using raw commands
      raw: |
        apt-get update -y
        apt-get install -y docker.io docker-compose-plugin curl wget git
      args:
        warn: false

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add user to docker group
      user:
        name: azureuser
        groups: docker
        append: yes

    - name: Create app directory
      file:
        path: /home/azureuser/shortifyaf
        state: directory
        owner: azureuser
        group: azureuser
        mode: "0755"

    - name: Create .env file with all required variables
      copy:
        dest: /home/azureuser/shortifyaf/.env
        content: |
          PORT=3001
          DATABASE_URL={{ database_url | default('') }}
          FRONTEND_URL={{ frontend_url | default('http://68.221.143.187/') }}
          AZURE_CLIENT_ID={{ azure_client_id | default('') }}
          AZURE_CLIENT_SECRET={{ azure_client_secret | default('') }}
          AZURE_TENANT_ID={{ azure_tenant_id | default('') }}
          ACR_LOGIN_SERVER={{ acr_login_server | default('') }}
        owner: azureuser
        group: azureuser
        mode: "0600"

    - name: Create docker-compose.yml file
      copy:
        dest: /home/azureuser/shortifyaf/docker-compose.yml
        content: |
          version: '3.8'
          services:
            backend:
              image: ${ACR_LOGIN_SERVER}/shortifyaf-backend:latest
              ports:
                - "3001:3001"
              environment:
                - PORT=3001
                - DATABASE_URL=${DATABASE_URL}
                - FRONTEND_URL=${FRONTEND_URL}
                - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
                - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET}
                - AZURE_TENANT_ID=${AZURE_TENANT_ID}
              restart: unless-stopped

            frontend:
              image: ${ACR_LOGIN_SERVER}/shortifyaf-frontend:latest
              ports:
                - "80:5173"
              environment:
                - VITE_API_URL=http://backend:3001
              restart: unless-stopped
              depends_on:
                - backend
        owner: azureuser
        group: azureuser
        mode: "0644"

    - name: Login to Azure Container Registry
      docker_login:
        registry: "{{ acr_login_server }}"
        username: "{{ azure_client_id }}"
        password: "{{ azure_client_secret }}"

    - name: Pull and start containers with docker compose V2
      community.docker.docker_compose_v2:
        project_src: /home/azureuser/shortifyaf
        files:
          - docker-compose.yml
        pull: yes
        state: present

    - name: Wait for backend to be healthy
      wait_for:
        port: 3001
        host: localhost
        delay: 5
        timeout: 60

    - name: Check application status
      uri:
        url: http://localhost:3001/health
        method: GET
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: 10
      delay: 5

    - name: Display application status
      debug:
        msg: "Application deployed successfully! Backend running on port 3001, Frontend on port 80"

    - name: Show running containers
      command: docker ps
      register: container_status

    - name: Display container status
      debug:
        var: container_status.stdout