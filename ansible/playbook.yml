---
- name: Ensure Docker and Dependencies are Installed
  hosts: app_servers
  become: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: Check if Docker is installed
      command: which docker
      register: docker_installed
      failed_when: false
      changed_when: false

    - name: Install Docker and dependencies if missing
      block:
        - name: Update apt cache
          apt: update_cache=yes
          
        - name: Install required packages
          apt:
            name:
              - curl
              - wget
              - git
              - python3
              - python3-pip
              - build-essential
              - ca-certificates
              - gnupg
              - lsb-release
              - apt-transport-https
              - software-properties-common
            state: present

        - name: Add Docker official GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present
            filename: docker

        - name: Install Docker Engine
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
            state: present

        - name: Install Docker Compose
          get_url:
            url: "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64"
            dest: /usr/local/bin/docker-compose
            mode: "0755"

        - name: Create symbolic link for docker-compose
          file:
            src: /usr/local/bin/docker-compose
            dest: /usr/bin/docker-compose
            state: link

        - name: Ensure Docker service is running
          systemd:
            name: docker
            state: started
            enabled: yes

        - name: Add azureuser to docker group
          user:
            name: azureuser
            groups: docker
            append: yes
      when: docker_installed.rc != 0